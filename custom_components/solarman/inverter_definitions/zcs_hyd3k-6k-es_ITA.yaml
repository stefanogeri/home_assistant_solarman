# Configurazione per Zucchetti HYD 3000/HYD 6000 (non versione HP)
# usato come file originale ed ispirazione "sofar_hyd3k-6k-es.yaml".

# - name: ".........."  = sensore/parametro italiano
#   attenzione modificando il nome del sensore home assistant potrebbe perdere la storia del relativo sensore
#   attenzione spazi ed allineamenti non corretti potrebbero compromettere il funzionamento del codice

# Testato con Zucchetti HYD6000 (non HP), potrebbe funzionare anche con altri inverter simili

#by StefanoGeri

requests:
# Storage inverter data table address
# inverter produzione ed extra
- start: 0x0200
  end:  0x0255
  mb_functioncode: 0x03
  
# Power Inverter parameter setting  
# Power Inverter parameter setting   
- start: 0x1000
  end: 0x1007
  mb_functioncode: 0x04
  
# Grid voltage protection parameter settings
# Impostazioni dei parametri di protezione della tensione di rete
- start: 0x1010
  end: 0x1019
  mb_functioncode: 0x04
  
# Grid frequency protection parameter settings  
# Impostazioni dei parametri di protezione della frequenza di rete
- start: 0x1020
  end: 0x1028
  mb_functioncode: 0x04

# DCI output current protection parameter set
# Uscita DCI Set di parametri di protezione
- start: 0x1030
  end: 0x1035
  mb_functioncode: 0x04
  
  
# # Active and remote control switch
# # Active and remote control switch
# - start: 0x1040
#   end: 0x104F
#   mb_functioncode: 0x04
  
# Active versus frequency derating function parameter setting
# Active versus frequency derating function parameter setting
# - start: 0x1050
#   end: 0x1056
#   mb_functioncode: 0x04  

# Reactive parameter settings
# Reactive parameter settings
# - start: 0x1060
#   end: 0x1074
#   mb_functioncode: 0x04 


# LVRT parameter settings
# LVRT parameter settings
# - start: 0x1080
#   end: 0x108C
#   mb_functioncode: 0x04 


# Other safety parameters set
# Other safety parameters set
# - start: 0x1090
#   end: 0x1093
#   mb_functioncode: 0x04 


# Other safety parameters set
# Other safety parameters set
    # - start: 0x10A0
    #   end: 0x10A3
    #   mb_functioncode: 0x04 

# Battery parameter register  
# Settaggi impostazione batterie
- start: 0x10B0
  end: 0x10BC
  mb_functioncode: 0x04  
  
# Inverter numero seriale e sw
- start: 0x2000
  end: 0x200F
  mb_functioncode: 0x04
# Informazioni sull'inverter [Inverter Information)
- start: 0x3000
  end: 0x301F
  mb_functioncode: 0x04

parameters:

 - group: 0x0200 - 0x0255
   items:
   
    - name: "Alert"
      class: ""
      state_class: ""
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0201,0x0202,0x0203,0x0204,0x0205,0x022B,0x0242,0x023D]
      icon: 'mdi:state-machine'

    - name: 'Alert1'
      class: ''
      state_class: ''
      uom: ''
      scale: 1
      rule: 6
      registers:
        [
          0x0201,
          0x0202,
          0x0203,
          0x0204,
          0x0205,
          0x022B,
          0x023D,
          0x0242,
        ]      
         
   
    - name: "Stato Inverter"
      class: "measurement"
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0200]
      isstr: true
      lookup:
      -  key: 0
         value: "Attesa"
      -  key: 1
         value: "Verifica"
      -  key: 2
         value: "Funzionamento Normale"
      -  key: 3
         value: "EPS"
      -  key: 4
         value: "Guasto"
      -  key: 5
         value: "Guasto Permanente"
      icon: 'mdi:state-machine'

    - name: "Guasti Tab1"    
      class: ""
      state_class: ""
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0201]
      isstr: true
      lookup:
      -  key: 0
         value: "Nessun Errore"
      -  key: 1
         value: "ID01 GridOVP (La tensione di rete è troppo elevata)"
      -  key: 2
         value: "ID02 GridUVP (La tensione di rete è troppo bassa)"
      -  key: 4
         value: "ID03 GridOFP (La frequenza di rete è troppo elevata)"
      -  key: 8
         value: "ID04 GridUFP (La frequenza di rete è troppo bassa)"
      -  key: 16
         value: "ID05 BatOVP (La tensione della batteria è troppo elevata)"
      -  key: 32
         value: "ID06 Vlvrtlow (Errore funzione LVRT)"
      -  key: 64
         value: "ID07 Vovrthigh (Errore funzione OVRT)"
      -  key: 128
         value: "ID08 PVOVP (La tensione del fotovoltaico è troppo elevata)"
      -  key: 256
         value: "ID09 HW_LLCBus_OVP (La tensione del LLCBus è troppo elevata e ha innescato la protezione hardware)"
      -  key: 512
         value: "ID10 HW_Boost_OVP (L’aumento di tensione è troppo alto e ha innescato la protezione hardware)"    
      -  key: 1024
         value: "ID11 HWBuckBoostOCP (La corrente BuckBoost è troppo alta e ha innescato la protezione hardware)"    
      -  key: 2048
         value: "ID12 HwBatOCP (La corrente della batteria è troppo alta e ha innescato la protezione hardware)"
      -  key: 4096
         value: "ID13 GFCI OCP (Il valore di campionatura GFCI fra il DSP master e il DSP slave non è adeguato)"
      -  key: 8192
         value: "ID14 HWPVOCP (La corrente fotovoltaica è troppo alta e ha innescato la protezione hardware)"
      -  key: 16384
         value: "ID15 HwAcOCP (La corrente di rete è troppo alta e ha innescato la protezione hardware)"
      -  key: 32768
         value: "ID16 IpvUnbalance (La corrente di ingresso fotovoltaica non è bilanciata)"
      icon: 'mdi:alert'

    - name: "Guasti Tab2"
      class: ""
      state_class: ""
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0202]
      isstr: true
      lookup:
      -  key: 0
         value: "Nessun Errore"
      -  key: 1
         value: "ID17 HwADFaultGrid (Errore nella campionatura della corrente di rete)"
      -  key: 2
         value: "ID18 HwADFaultDCI (Errore di campionatura DCI)"
      -  key: 4
         value: "ID19 HwADFaultVGrid (Errore nella campionatura della tensione di rete)"
      -  key: 8
         value: "ID20 GFCIDeviceFault (Errore di campionatura GFCI)"
      -  key: 16
         value: "ID21 MChip_Fault (Guasto del chip principale)"
      -  key: 32
         value: "ID22 HwAuxPowerFault (Errore della tensione ausiliare)"
      -  key: 64
         value: "ID23 - nd"
      -  key: 128
         value: "ID24 - nd"
      -  key: 256
         value: "ID25 LLCBusOVP (La tensione del LLCBus è troppo alta)"
      -  key: 512
         value: "ID26 SwBusOVP (La tensione del bus è troppo alta e ha innescato la protezione hardware)"
      -  key: 1024
         value: "ID27 BatOCP (La corrente della batteria è troppo elevata)"
      -  key: 2048
         value: "ID28 DciOCP (La corrente DCI è troppo alta)"
      -  key: 4096
         value: "ID29 SwOCPInstant (La corrente di rete è troppo alta)"
      -  key: 8192
         value: "ID30 BuckOCP (La corrente sulla sezione Buck è troppo alta)"
      -  key: 16384
         value: "ID31 AcRmsOCP (La corrente di uscita è troppo alta)"
      -  key: 32768
         value: "ID32 SwBOCPInstant (La corrente di ingresso è troppo alta)"
      icon: 'mdi:alert'

    - name: "Guasti Tab3"
      class: ""
      state_class: ""
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0203]
      isstr: true
      lookup:
      -  key: 0
         value: "Nessun Errore"
      -  key: 1
         value: "ID33 PvConfigSetWrong (La modalità di input è impostata in modo errato)"
      -  key: 2
         value: "ID34 Overload (Sovraccarico)"
      -  key: 4
         value: "ID35 CT Fault (Il CT è guasto)"
      -  key: 8
         value: "ID36 nd"
      -  key: 16
         value: "ID37 nd"
      -  key: 32"
         value: "ID38 nd"
      -  key: 64"
         value: "ID39 nd"
      -  key: 128
         value: "ID40 nd"
      -  key: 256
         value: "ID41 nd"
      -  key: 512
         value: "ID42 nd"
      -  key: 1024
         value: "ID43 nd"
      -  key: 2048
         value: "ID44 nd"
      -  key: 4096
         value: "ID45 nd"
      -  key: 8192
         value: "ID46 nd"
      -  key: 16384
         value: "ID47 nd"
      -  key: 32768
         value: "ID48 Errore Permanente (Il valore di campionatura GFCI fra il DSP master e il DSP slave non è adeguato)"
      icon: 'mdi:alert'

    - name: "Guasti Tab4" 
      class: ""
      state_class: ""
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0204]
      isstr: true
      lookup:
      -  key: 0
         value: "Nessun Errore"
      -  key: 1
         value: "ID49 ConsistentFault_Vgrid (Il valore di campionatura della tensione di rete fra il DSP master e il DSP slave non è adeguato.)"    
      -  key: 2
         value: "ID50 ConsistentFault_Fgrid (Il valore di campionatura della frequenza di rete fra il DSP master e il DSP slave non è adeguato)"
      -  key: 4
         value: "ID51 ConsistentFault_DCI (Il valore DCI misurato dal DSP master e dal DSP slave non è coerente)"
      -  key: 8
         value: "ID52 BatCommunicationFlag (Manca la comunicazione tra inverter e batterie)"
      -  key: 16
         value: "ID53 SpiCommLose (La comunicazione SPI tra il DSP master e il DSP slave è difettosa)"
      -  key: 32
         value: "ID54 SciCommLose (La comunicazione SCI tra scheda di controllo e comunicazione è difettosa)"
      -  key: 64
         value: "ID55 RecoverRelayFail (Guasto ai relè)"
      -  key: 128
         value: "ID56 PvIsoFault (La resistenza di isolamento ha un valore troppo basso)"
      -  key: 256
         value: "ID57 OverTempFault_BAT (La temperatura della batteria è troppo alta)"
      -  key: 512
         value: "ID58 OverTempFault_HeatSink (La temperatura del dissipatore di calore è troppo alta)"
      -  key: 1024
         value: "ID59 OverTempFault_Env (La temperatura ambiente è troppo alta)"
      -  key: 2048
         value: "ID60 PE connectFault (Messa a terra non corretta)"
      -  key: 4096
         value: "ID61 nd"
      -  key: 8192
         value: "ID62 nd"
      -  key: 16384
         value: "ID63 nd"
      -  key: 32768
         value: "ID64 nd"
      icon: 'mdi:alert'

    - name: "Guasti Tab5" 
      class: ""
      state_class: ""
      uom: ""
      scale: 1
      rule: 1
      registers: [0x0205]
      isstr: true
      lookup:
      -  key: 0
         value: "Nessun Errore"
      -  key: 1
         value: "ID65 UnrecoverHwAcOCP (La corrente di rete è troppo alta e ha causato un guasto hardware irrimediabile)"
      -  key: 2
         value: "ID66 UnrecoverBusOVP (La tensione del bus è troppo alta e ha causato un guasto irrimediabile)"
      -  key: 4
         value: "ID67 EPSunrecoverBatOCP (Guasto irrimediabile sovracorrente batteria in modalità EPS)" 
      -  key: 8
         value: "ID68 UnrecoverIpvUnbalance (La corrente di ingresso fotovoltaica è sbilanciata e ha causato un guasto irrimediabile.)"
      -  key: 16
         value: "ID69 nd"
      -  key: 32
         value: "ID70 UnrecoverOCPInstant (La corrente di rete è troppo alta e ha causato un guasto irrimediabile)"
      -  key: 64
         value: "ID71 nd"    
      -  key: 128
         value: "ID72 nd"
      -  key: 256
         value: "ID73 UnrecoverPVConfigSetWrong (La modalità di input è impostata in modo errato)"
      -  key: 512
         value: "ID74 UnrecoverIpvInstant (La corrente di ingresso è troppo elevata e ciò ha causato un errore hardware irreversibile)"    
      -  key: 1024
         value: "ID75 UnrecoverWRITEEEPROM (La EEPROM è irrecuperabile)"    
      -  key: 2048
         value: "ID76 UnrecoverREADEEPROM (La EEPROM è irrecuperabile)"    
      -  key: 4096
         value: "ID77 UnrecoverRelayFail (Il relè è in guasto permanente)"    
      -  key: 8192
         value: "ID78 nd"
      -  key: 16384
         value: "ID79 nd"    
      -  key: 32768
         value: "ID80 nd"    
      icon: 'mdi:alert'

    - name: "Rete-AC Tensione"
      class: "Voltage"
      state_class: "measurement"
      uom: "V"
      scale: 0.1
      rule: 1
      registers: [0x0206]
      icon: 'mdi:transmission-tower'

    - name: "Rete-AC Corrente"
      class: "Current"
      state_class: "measurement"
      uom: "A"
      scale: 0.01
      rule: 2
      registers: [0x0207]
      icon: 'mdi:transmission-tower'
      
    # - name: "Riserv. 0x0208"
    #   class: ""
    #   state_class: ""
    #   uom: ""
    #   scale: 1
    #   rule: 1
    #   registers: [0x0208]
    #   icon: ''

    # - name: "Riserv. 0x0209"
    #   class: ""
    #   state_class: ""
    #   uom: ""
    #   scale: 1
    #   rule: 1
    #   registers: [0x0209]
    #   icon: ''
      
    # - name: "Riserv. 0x020A"
    #   class: ""
    #   state_class: ""
    #   uom: ""
    #   scale: 1
    #   rule: 1
    #   registers: [0x020A]
    #   icon: ''
      
    # - name: "Riserv. 0x020B"
    #   class: ""
    #   state_class: ""
    #   uom: ""
    #   scale: 1
    #   rule: 1
    #   registers: [0x020B]
    #   icon: ''
      
    - name: "Rete-AC Frequenza"
      class: "frequency"
      state_class: "measurement"
      uom: "Hz"
      scale: 0.01
      rule: 1
      registers: [0x020C]
      icon: 'mdi:transmission-tower'
      
    - name: "Carica/Scarica Attuale"
      class: "power"
      state_class: "measurement"
      uom: "kW"
      scale: 0.01
      rule: 2
      registers: [0x020D]
      icon: 'mdi:battery-charging'
      
    - name: "Batt. Tensione"    
      class: "Voltage"
      state_class: "measurement"
      uom: "V"
      scale: 0.1
      rule: 1
      registers: [0x020E]
      icon: 'mdi:battery-charging'      
   
    - name: "Carica/Scarica Corrente (Attuale)" 
      class: "Current"
      state_class: "measurement"
      uom: "A"
      scale: 0.01
      rule: 2
      registers: [0x020F]
      icon: 'mdi:battery-charging'
      
    - name: "Batt.SOC (liv. carica Attuale)"
      class: "battery"
      state_class: "measurement"
      uom: "%"
      scale: 1
      rule: 1
      registers: [0x0210]
      icon: 'mdi:battery-90'      

    - name: "Temp Batterie"
      class: "temperature"
      state_class: "measurement"
      uom: "°C"
      scale: 1 # se non funziona cambia questo in 2
      rule: 1
      registers: [0x0211]
      icon: 'mdi:thermometer'

    - name: "Energia Rete Immessa-Prelevata (Attuale)"
      class: "power"
      state_class: "measurement"
      uom: "kW"
      scale: 0.01
      rule: 2
      registers: [0x0212]
      icon: 'mdi:lightning-bolt'
      
    - name: "Consumo (Attuale)"
      class: ""
      state_class: ""
      uom: "KW"
      scale: 0.01
      rule: 1
      registers: [0x0213]
      icon: 'mdi:home-lightning-bolt'      
      
    - name: "Energia ingresso-uscita (Attuale)"
      class: "power"
      state_class: "measurement"
      uom: "kW"
      scale: 0.01
      rule: 2
      registers: [0x0214]
      icon: 'mdi:lightning-bolt'
      
    - name: "Energia FV (Attuale)"
      class: "power"
      state_class: "measurement"
      uom: "kW"
      scale: 0.01
      rule: 1
      registers: [0x0215]
      icon: 'mdi:solar-power'      
      
    - name: "EPS Tensione di uscita"
      class: "Voltage"
      state_class: "measurement"
      uom: "V"
      scale: 0.1
      rule: 1
      registers: [0x0216]
      icon: 'mdi:lightning-bolt'

    - name: "EPS Potenza di uscita"
      class: "power"
      state_class: "measurement"
      uom: "kW"
      scale: 0.01
      rule: 2
      registers: [0x0217]
      icon: 'mdi:lightning-bolt'

    - name: "Energia FV Prodotta (GG)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 0.01
      rule: 1
      registers: [0x0218]
      icon: 'mdi:solar-power'

    - name: "Energia-Rete Immessa (GG)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 0.01
      rule: 1
      registers: [0x0219]
      icon: 'mdi:transmission-tower-export'

    - name: "Energia-Rete Acquistata (GG)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 0.01
      rule: 1
      registers: [0x021A]
      icon: 'mdi:transmission-tower-import'
  
    - name: "Energia Consumata (GG)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 0.01
      rule: 1
      registers: [0x021B]
      icon: 'mdi:lightning-bolt'
      
    - name: "Energia FV Prodotta 0x021C (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x021C]
      icon: 'mdi:solar-power'
      
    - name: "Energia FV Prodotta 0x021D (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x021D]
      icon: 'mdi:solar-power'

    - name: "Energia FV Prodotta (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x021D,0x021C]
      icon: 'mdi:solar-power'

    - name: "Energia-Rete Immessa 0x021E (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x021E]
      icon: 'mdi:transmission-tower-export'
      
    - name: "Energia-Rete Immessa 0x021F (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x021F]
      icon: 'mdi:transmission-tower-export'
      
    - name: "Energia-Rete Immessa (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x021F,0x021E]
      icon: 'mdi:transmission-tower-export'
      
    - name: "Energia-Rete Acquistata 0x0220 (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "KWh"
      scale: 1
      rule: 3
      registers: [0x0220]
      icon: 'mdi:transmission-tower-import'
     
    - name: "Energia-Rete Acquistata 0x0221 (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "KWh"
      scale: 1
      rule: 3
      registers: [0x0221]
      icon: 'mdi:transmission-tower-import'      

    - name: "Energia-Rete Acquistata (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x0221,0x0220]
      icon: 'mdi:transmission-tower-import'
      
    - name: "Energia Consumata 0x0222 (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x0222]
      icon: 'mdi:lightning-bolt'
      
    - name: "Energia Consumata 0x0223 (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x0223]
      icon: 'mdi:lightning-bolt'
    
    - name: "Energia Consumata (TT)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 1
      rule: 3
      registers: [0x0223,0x0222]
      icon: 'mdi:lightning-bolt' 
      
    - name: "Energia Caricata (GG)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 0.01
      rule: 1
      registers: [0x0224]
      icon: 'mdi:battery-arrow-up'

    - name: "Energia Scaricata (GG)"
      class: "energy"
      state_class: "total_increasing"
      uom: "kWh"
      scale: 0.01
      rule: 1
      registers: [0x0225]
      icon: 'mdi:battery-arrow-down